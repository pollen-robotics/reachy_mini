<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/dashboard/style.css">
</head>

<body>
    <h1>Dashboard</h1>

    <!-- Tab Navigation -->
    <div class="tab-container">
        <div class="tab-nav">
            <button class="tab-button active" data-tab="control">Control</button>
            <button class="tab-button" data-tab="renderer">Renderer</button>
            <button class="tab-button" data-tab="video">Video</button>
            <button class="tab-button" data-tab="examples">Examples</button>
        </div>

        <!-- Control Tab -->
        <div class="tab-content active" id="control-tab">
            <section id="daemon-control">
                <h2>Daemon Control</h2>
                <div id="daemon-status">Loading daemon status...</div>
                <button id="start-daemon">Start Daemon</button>
                <button id="stop-daemon">Stop Daemon</button>
                <button id="restart-daemon">Restart Daemon</button>
                <label><input type="checkbox" id="wake-up-on-start" checked> Wake up on start</label>
                <label><input type="checkbox" id="goto-sleep-on-stop" checked> Go to sleep on stop</label>
            </section>
        </div>

        <!-- Renderer Tab -->
        <div class="tab-content" id="renderer-tab">
            <h2>MuJoCo Renderer</h2>
            <iframe id="mujoco-iframe" src="" style="width: 100%; height: 80vh; border: none; display: none;"></iframe>
            <div id="mujoco-container" style="width: 100%; height: 80vh; position: relative; background: #264059;">
                <div id="loading-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white;">Loading MuJoCo Renderer...</div>
            </div>
        </div>

        <!-- Video Tab -->
        <div class="tab-content" id="video-tab">
            <h2>Video Stream</h2>
            <div id="video-stream">
                <div class="video">
                    <video id="video"></video>
                </div>
            </div>
            <input type="text" id="video-ip" placeholder="IP address" value="pierre-pi.local" style="margin-right:8px;">
            <button id="connect-video">Connect</button>
        </div>

        <!-- Examples Tab -->
        <div class="tab-content" id="examples-tab">
            <h2>Examples</h2>
            <ul id="examples-list">
                {% for fname in files %}
                <li><a href="/dashboard/{{ fname }}">{{ fname }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <script src="/dashboard/js/3rdparty/gstwebrtc-api-2.0.0.min.js"></script>
    <script src="/dashboard/js/dashboard.js"></script>
    <script>
        // Tab functionality
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');

                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');

                    // Initialize MuJoCo when renderer tab is activated
                    if (targetTab === 'renderer' && !window.mujocoInitialized) {
                        initMujocoRenderer();
                        window.mujocoInitialized = true;
                    }
                });
            });
        }

        // Simple MuJoCo renderer using iframe as fallback
        function initMujocoRenderer() {
            const iframe = document.getElementById('mujoco-iframe');
            const container = document.getElementById('mujoco-container');
            const loadingText = document.getElementById('loading-text');

            try {
                // Load the MuJoCo React app in iframe to avoid Web Worker issues
                iframe.src = '/wasm/dist/index.html';
                iframe.style.display = 'block';
                container.style.display = 'none';

                iframe.onload = function() {
                    console.log('MuJoCo renderer loaded in iframe');
                    // Try to communicate with the iframe to sync robot state
                    try {
                        setInterval(() => {
                            // Send robot state to iframe (if same-origin)
                            if (iframe.contentWindow) {
                                fetch('/api/state/full?with_head_joints=true&with_antenna_positions=true&with_head_pose=true')
                                    .then(response => response.json())
                                    .then(robotState => {
                                        iframe.contentWindow.postMessage({
                                            type: 'robotState',
                                            data: robotState
                                        }, '*');
                                    })
                                    .catch(console.warn);
                            }
                        }, 100);
                    } catch (e) {
                        console.warn('Cannot communicate with iframe:', e);
                    }
                };

                iframe.onerror = function() {
                    iframe.style.display = 'none';
                    container.style.display = 'block';
                    container.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">Failed to load MuJoCo renderer</div>';
                };

            } catch (error) {
                console.error('Error initializing MuJoCo renderer:', error);
                iframe.style.display = 'none';
                container.style.display = 'block';
                container.innerHTML = `<div style="text-align: center; color: red; padding: 20px;">Error: ${error.message}</div>`;
            }
        }

        // Initialize tabs when DOM is loaded
        document.addEventListener('DOMContentLoaded', initTabs);
    </script>
</body>

</html>